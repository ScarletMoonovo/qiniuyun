# 语音聊天功能配置指南

## 功能概述

语音聊天功能集成了阿里云的实时语音识别服务，允许用户通过语音与AI进行交互。用户说话的内容会被实时转换为文字，然后以`voice`类型的消息发送给后端。

## 配置步骤

### 1. 配置说明

语音识别功能已经内置了阿里云的配置：

- **AppKey**: 已固定为 `gEoJFpChxpzCPHky`
- **Token**: 通过调用后端 `/api/upload/token` 接口动态获取

### 2. 后端接口要求

确保后端已实现 `uploadToken` 接口：

```typescript
// 接口路径: POST /api/upload/token
// 返回格式:
{
  url: string;
  token: string;  // 用于阿里云语音识别的访问令牌
  expire: number;
  key: string;
}
```

**注意：** 
- Token应该是有效的阿里云语音识别访问令牌
- 建议在后端实现Token的缓存和自动刷新机制
- Token有效期通常为24小时

## 功能使用

### 启动语音聊天

1. 在聊天界面，点击右上角的语音按钮（🔇图标）
2. 系统会尝试连接阿里云语音识别服务
3. 连接成功后，按钮会变为蓝色（🔊图标），并显示"语音已连接"状态

### 开始录音

1. 点击录音按钮（🎤图标）开始录音
2. 说话时，系统会实时显示识别的文字
3. 再次点击录音按钮停止录音
4. 识别完成的文字会自动发送给AI

### 关闭语音模式

点击语音按钮（🔊图标）关闭语音模式，断开与阿里云的连接。

## 技术实现

### 消息类型

语音消息使用特殊的消息类型发送给后端：

```typescript
{
  type: 'voice',
  content: '识别到的文字内容'
}
```

后端可以根据 `type: 'voice'` 来识别这是语音输入的消息，并进行相应的处理。

### 音频格式

- 采样率：16kHz
- 格式：PCM 16位
- 声道：单声道
- 缓冲区大小：2048

### 浏览器兼容性

该功能需要浏览器支持：
- WebSocket
- Web Audio API
- MediaDevices getUserMedia API

建议使用现代浏览器（Chrome 60+, Firefox 55+, Safari 11+）。

## 故障排除

### 常见问题

1. **"获取语音识别授权失败"**
   - 检查后端 `/api/upload/token` 接口是否正常工作
   - 确认接口返回的token字段不为空
   - 验证后端阿里云配置是否正确

2. **"无法访问麦克风，请检查权限设置"**
   - 确认浏览器已授权麦克风权限
   - 检查操作系统麦克风权限设置

3. **语音识别连接失败**
   - 检查网络连接
   - 验证AppKey和Token的有效性
   - 确认阿里云服务状态

4. **识别准确率低**
   - 确保环境安静
   - 说话清晰，语速适中
   - 检查麦克风质量

### 调试信息

打开浏览器开发者工具，查看Console面板中的日志信息，可以帮助诊断问题。

## 安全注意事项

1. Token通过后端接口动态获取，提高安全性
2. 后端应验证用户权限后再返回Token
3. 建议在后端实现Token缓存，避免频繁请求阿里云
4. 定期更新访问令牌，确保服务稳定性

## 扩展功能

可以在此基础上扩展以下功能：
- 语音合成（Text-to-Speech）
- 多语言识别
- 自定义词汇表
- 语音情感识别
- 语音指令识别

